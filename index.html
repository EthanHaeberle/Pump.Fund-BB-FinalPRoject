<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crowdfunding Platform</title>
    <link rel="stylesheet" href="Pump.Fund styling.css">
</head>
<body>
    <div class="container">
        <h1>Welcome to Pump.Fund!</h1>

        <!-- MetaMask Connection -->
        <section id="metamask-connection">
            <button id="connectButton">Connect MetaMask</button>
            <div id="status"></div>
        </section>

        <!-- Campaigns Section -->
        <section id="campaigns">
            <h2>Open Campaigns</h2>
            <div id="campaign-list"></div>
        </section>

        <!-- Campaign Details Section -->
        <section id="campaign-details" style="display:none;">
            <h2>Campaign Details</h2>
            <div id="details"></div>
            <button onclick="goBack()">Back to Campaigns</button>
        </section>

        <!-- Contribute Section -->
        <section id="contribution">
            <h2>Contribute</h2>
            <input type="number" id="amount" placeholder="Enter ETH amount">
            <button onclick="makeContribution()">Contribute</button>
        </section>

        <!-- Create Campaign Section -->
        <section id="create-campaign">
            <h2>Create New Campaign</h2>
            <input type="text" id="campaign-name" placeholder="Campaign Name">
            <textarea id="campaign-description" placeholder="Campaign Description"></textarea>
            <input type="number" id="campaign-goal" placeholder="Goal Amount (ETH)">
            <input type="number" id="campaign-duration" placeholder="Duration (Days)">
            <button onclick="createCampaign()">Create Campaign</button>
        </section>
    </div>

    <script src="ABI.js"></script>
    <script src="Web back end.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/web3@1.6.0/dist/web3.min.js"></script>

    <script>
        let web3;
        let contract;
        let userAccount;
        const contractAddress = '0x5dBe8571E483b759Ce823B1C2F3D206a0E27dDb8'; 
        const contractABI = [ [
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "uint256",
				"name": "campaignId",
				"type": "uint256"
			},
			{
				"indexed": true,
				"internalType": "address",
				"name": "creator",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "string",
				"name": "name",
				"type": "string"
			},
			{
				"indexed": false,
				"internalType": "string",
				"name": "description",
				"type": "string"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "goalAmountEth",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "deadline",
				"type": "uint256"
			}
		],
		"name": "CampaignCreated",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "uint256",
				"name": "campaignId",
				"type": "uint256"
			},
			{
				"indexed": true,
				"internalType": "address",
				"name": "contributor",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "amountEth",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "refundedEth",
				"type": "uint256"
			}
		],
		"name": "ContributionMade",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "uint256",
				"name": "campaignId",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "amountEth",
				"type": "uint256"
			}
		],
		"name": "FundsWithdrawn",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "uint256",
				"name": "campaignId",
				"type": "uint256"
			},
			{
				"indexed": true,
				"internalType": "address",
				"name": "contributor",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "amountEth",
				"type": "uint256"
			}
		],
		"name": "RefundIssued",
		"type": "event"
	},
	{
		"inputs": [],
		"name": "campaignCount",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"name": "campaigns",
		"outputs": [
			{
				"internalType": "address payable",
				"name": "creator",
				"type": "address"
			},
			{
				"internalType": "string",
				"name": "name",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "description",
				"type": "string"
			},
			{
				"internalType": "uint256",
				"name": "goalAmount",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "pledgedAmount",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "deadline",
				"type": "uint256"
			},
			{
				"internalType": "bool",
				"name": "fundsClaimed",
				"type": "bool"
			},
			{
				"internalType": "bool",
				"name": "goalReached",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "_campaignId",
				"type": "uint256"
			}
		],
		"name": "claimRefund",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "_campaignId",
				"type": "uint256"
			}
		],
		"name": "contribute",
		"outputs": [],
		"stateMutability": "payable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "_name",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "_description",
				"type": "string"
			},
			{
				"internalType": "uint256",
				"name": "_goalAmountEth",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "_durationInDays",
				"type": "uint256"
			}
		],
		"name": "createCampaign",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "_campaignId",
				"type": "uint256"
			}
		],
		"name": "getCampaignDetails",
		"outputs": [
			{
				"internalType": "address",
				"name": "creator",
				"type": "address"
			},
			{
				"internalType": "string",
				"name": "name",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "description",
				"type": "string"
			},
			{
				"internalType": "uint256",
				"name": "goalAmountEth",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "pledgedAmountEth",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "deadline",
				"type": "uint256"
			},
			{
				"internalType": "bool",
				"name": "fundsClaimed",
				"type": "bool"
			},
			{
				"internalType": "bool",
				"name": "goalReached",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "_campaignId",
				"type": "uint256"
			}
		],
		"name": "getMyContribution",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "amountEth",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "getOpenCampaigns",
		"outputs": [
			{
				"internalType": "string[]",
				"name": "",
				"type": "string[]"
			},
			{
				"internalType": "string[]",
				"name": "",
				"type": "string[]"
			},
			{
				"internalType": "string[]",
				"name": "",
				"type": "string[]"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "_campaignId",
				"type": "uint256"
			}
		],
		"name": "withdrawFunds",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	}
] ];

        // MetaMask connection logic
        document.getElementById('connectButton').addEventListener('click', async () => {
            if (window.ethereum) {
                // Request account access (MetaMask will show a pop-up)
                try {
                    await window.ethereum.request({ method: 'eth_requestAccounts' });
                    userAccount = await web3.eth.getAccounts();
                    document.getElementById('status').textContent = `Connected: ${userAccount[0]}`;
                    initializeWeb3();
                } catch (error) {
                    console.log('User denied account access or MetaMask error');
                    alert('Please connect MetaMask!');
                }
            } else {
                console.log('MetaMask is not installed');
                alert('Please install MetaMask to interact with the platform.');
            }
        });

        function initializeWeb3() {
            web3 = new Web3(window.ethereum);
            contract = new web3.eth.Contract(contractABI, contractAddress);
            console.log('Web3 initialized with MetaMask');
            loadCampaigns();
        }

        async function loadCampaigns() {
            const campaigns = await contract.methods.getOpenCampaigns().call();
            const campaignListElement = document.getElementById('campaign-list');
            campaignListElement.innerHTML = ''; // Clear the current list

            campaigns[0].forEach((campaignName, index) => {
                const campaignId = campaigns[1][index];
                const description = campaigns[2][index];
                const campaignElement = document.createElement('div');
                campaignElement.innerHTML = `
                    <h3>${campaignName}</h3>
                    <p>${description}</p>
                    <button onclick="viewCampaignDetails(${campaignId})">View Details</button>
                `;
                campaignListElement.appendChild(campaignElement);
            });
        }

        function viewCampaignDetails(campaignId) {
            // Function to load campaign details
            contract.methods.getCampaignDetails(campaignId).call().then((details) => {
                const { name, description, goalAmountEth, pledgedAmountEth, deadline } = details;
                document.getElementById('campaign-details').style.display = 'block';
                document.getElementById('details').innerHTML = `
                    <h3>${name}</h3>
                    <p>${description}</p>
                    <p>Goal: ${goalAmountEth} ETH</p>
                    <p>Pledged: ${pledgedAmountEth} ETH</p>
                    <p>Deadline: ${new Date(deadline * 1000).toLocaleString()}</p>
                `;
            });
        }

        function goBack() {
            document.getElementById('campaign-details').style.display = 'none';
        }

        async function makeContribution() {
            const campaignId = document.getElementById('campaignId').value;
            const amount = document.getElementById('amount').value;

            if (!userAccount) {
                alert('Please connect MetaMask first.');
                return;
            }

            try {
                await contract.methods.contribute(campaignId).send({
                    from: userAccount[0],
                    value: web3.utils.toWei(amount, 'ether')
                });
                alert('Contribution successful!');
            } catch (error) {
                console.error('Error contributing to campaign:', error);
                alert('Error making the contribution.');
            }
        }

        async function createCampaign() {
            const name = document.getElementById('campaign-name').value;
            const description = document.getElementById('campaign-description').value;
            const goal = document.getElementById('campaign-goal').value;
            const duration = document.getElementById('campaign-duration').value;

            if (!userAccount) {
                alert('Please connect MetaMask first.');
                return;
            }

            try {
                await contract.methods.createCampaign(name, description, goal, duration).send({
                    from: userAccount[0]
                });
                alert('Campaign created successfully!');
            } catch (error) {
                console.error('Error creating campaign:', error);
                alert('Error creating the campaign.');
            }
        }
    </script>
</body>
</html>
